name: Build and Release

on:
  workflow_dispatch:

env:
  ARTIFACT_RETENTION_DAYS: 30

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            .gradle
            build
          key: ${{ runner.os }}-gradle-store-${{ hashFiles('**/gradle.properties') }}-${{ hashFiles('**/build.gradle') }}-${{ hashFiles('**/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-store-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew build

      - name: Extract version and prepare artifacts
        id: prepare
        run: |
          cd build/libs

          # Find the main JAR file
          MAIN_JAR=$(find . -name "mob_mementos-*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -1)

          if [[ -z "$MAIN_JAR" ]]; then
            echo "Error: No main JAR file found"
            exit 1
          fi

          echo "Found JAR: $MAIN_JAR"

          # Extract version from filename
          MOD_VERSION=$(echo "$MAIN_JAR" | sed -E 's/.*mob_mementos-([0-9]+\.[0-9]+\.[0-9]+)(-SNAPSHOT)?\.jar/\1/')

          if [[ -z "$MOD_VERSION" ]]; then
            echo "Error: Could not extract version from filename"
            exit 1
          fi

          echo "Extracted version: $MOD_VERSION"
          echo "MOD_VERSION=$MOD_VERSION" >> $GITHUB_OUTPUT

          # Rename file
          NEW_NAME="mob_mementos-${MOD_VERSION}-beta.${GITHUB_RUN_NUMBER}.jar"
          echo "Renaming $MAIN_JAR to $NEW_NAME"
          mv "$MAIN_JAR" "$NEW_NAME"
          echo "FILE_NAME=$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: mob_mementos-${{ steps.prepare.outputs.MOD_VERSION }}-beta.${{ github.run_number }}
          path: "build/libs/mob_mementos-*.jar"
          if-no-files-found: error
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Create Release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          name: Prerelease v${{ steps.prepare.outputs.MOD_VERSION }}-beta.${{ github.run_number }}
          body: "| CI Run | [#${{ github.run_id }}](https://github.com/the-drunken-cod/Mob-Mementos/actions/runs/${{ github.run_id }}) |\n| :-- | :-- |\n| Event | `${{ github.event_name }}` |\n| Branch | `${{ github.ref_name }}` |\n| Commit | ${{ github.sha }} |\n| Actor | @${{ github.actor }} |"
          draft: false
          fail_on_unmatched_files: true
          files: build/libs/${{ steps.prepare.outputs.FILE_NAME }}
          make_latest: true
          prerelease: true
          tag_name: v${{ steps.prepare.outputs.MOD_VERSION }}-beta.${{ github.run_number }}
          target_commitish: ${{ github.sha }}
